<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mijn Dashboard • Vrijeplek</title>
  <link rel="stylesheet" href="/styles.css?v=15">
  <meta name="robots" content="noindex">
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bg:#f8fafc; --card:#ffffff;
      --brand:#0ea5e9; --radius:16px; --shadow:0 10px 30px rgba(2,8,23,.08);
    }
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .grow{flex:1 1 320px}
    h1{margin:0 0 12px 0;font-size:28px}
    h2{margin:0 0 10px 0;font-size:20px}
    .muted{color:var(--muted)}
    button, .btn{background:var(--ink);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:var(--brand);color:#001018}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:8px 0}
    .kv b{color:#111}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    a{color:var(--brand);text-decoration:none}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <a href="/" class="muted">← Terug</a>
      </div>
      <div>
        <button id="logoutBtn" title="Uitloggen">Uitloggen</button>
      </div>
    </div>

    <div class="card">
      <h1>Welkom, <span id="displayName">—</span></h1>
      <p class="muted" id="emailLine">Ingelogd als —</p>

      <div class="row" style="margin-top:20px">
        <div class="grow card">
          <h2>Account</h2>
          <div class="kv"><b>Naam</b><span id="kv_name">—</span></div>
          <div class="kv"><b>E-mail</b><span id="kv_email">—</span></div>
          <div class="kv"><b>Status</b><span id="kv_status">—</span></div>
        </div>

        <div class="grow card">
          <h2>Snelstart</h2>
          <p class="muted">Klaar om je vrije plekken te plaatsen?</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <a class="btn secondary" href="/aanbod-nieuw.html">+ Nieuw aanbod</a>
            <a class="btn" href="/aanbod.html">Mijn aanbiedingen</a>
          </div>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:16px">Probleem? <a href="/contact.html">Contact</a></p>
  </div>

<script>
  // --- CONFIG: zet je project URL en anon key hier (client-keys mogen publiek) ---
  const SUPABASE_URL = window.SUPABASE_URL || "https://YOUR_PROJECT_REF.supabase.co";
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "YOUR_PUBLIC_ANON_KEY";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Utility: veilige redirect
  function go(path){ window.location.href = path; }

  // Guard: alleen zichtbaar voor ingelogde users
  async function requireSession() {
    // 1) pak huidige sessie
    const { data: { session } } = await supabase.auth.getSession();

    // 2) Als geen sessie: check of we net via bevestigingslink/redirect kwamen
    if (!session) {
      // Probeer nog één keer de URL-fragmenten (access_token) te verwerken
      const { data: { session: recovered } } = await supabase.auth.getSession();
      if (!recovered) {
        // Niet ingelogd -> terug naar login
        go("/inloggen.html");
        return null;
      }
      return recovered;
    }
    return session;
  }

  async function load() {
    const session = await requireSession();
    if (!session) return;

    const user = session.user;

    // Vul UI
    const email = user.email || "—";
    const name = user.user_metadata?.full_name || user.user_metadata?.name || email.split("@")[0];

    document.getElementById("displayName").textContent = name;
    document.getElementById("emailLine").textContent = `Ingelogd als ${email}`;
    document.getElementById("kv_name").textContent = name;
    document.getElementById("kv_email").textContent = email;
    document.getElementById("kv_status").textContent = user.confirmed_at ? "Geactiveerd" : "Onbevestigd";

    // (Optioneel) Laad extra profielgegevens uit een 'profiles' tabel
    // const { data: profile } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
    // if (profile) { ... }
  }

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    go("/inloggen.html");
  });

  // Reageer ook op auth-wijzigingen (bv. na magic link)
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_IN") {
      // herlaad UI wanneer sessie binnenkomt
      load();
    } else if (event === "SIGNED_OUT") {
      go("/inloggen.html");
    }
  });

  load();
</script>
</body>
</html>

